<div *ngIf="error" class="login-error-banner" role="alert" aria-live="assertive">
  <div class="msg">{{ error }}</div>
</div>
<div *ngIf="success" class="login-error-banner sucesso" role="status" aria-live="polite">
  <div class="msg">{{ success }}</div>
</div>
<app-menu></app-menu>
<div class="empresa-container" *ngIf="companyLoaded">
  <h2 class="gradient-title" *ngIf="isSupport && !showCreateForSupport">Empresas Cadastradas</h2>
  <h2 class="gradient-title" *ngIf="isSupport && showCreateForSupport">Cadastrar Empresa</h2>
  <h2 class="gradient-title" *ngIf="!isSupport && !hasCompany">Cadastrar Empresa</h2>
  <h2 class="gradient-title" *ngIf="!isSupport && hasCompany">Empresa</h2>

  <div *ngIf="!isSupport && hasCompany && companyData" class="empresa-box">
    <ng-container *ngIf="!editing; else editFormTpl">
      <p><strong>Nome:</strong> {{ companyData.name }}</p>
      <p><strong>CNPJ:</strong> {{ viewCnpj(companyData.cnpj) }}</p>
      <p><strong>Endereço:</strong> {{ companyData.address }} - {{ companyData.neighborhood }}</p>
      <p><strong>Cidade/UF:</strong> {{ companyData.municipality }} / {{ companyData.state }}</p>
      <p><strong>País:</strong> {{ companyData.country }}</p>
      <p><strong>Telefone:</strong> {{ viewPhone(companyData.phone) }}</p>
      <div class="acoes-empresa" *ngIf="role === 'admin'">
        <button type="button" class="btn-primario" (click)="iniciarEdicao()">Editar dados</button>
      </div>
    </ng-container>
  </div>

  <ng-template #editFormTpl>
    <form (ngSubmit)="atualizarEmpresa()" #editEmpresaForm="ngForm" class="empresa-edit-form">
      <div class="row">
        <label>Nome*</label><input name="name" [(ngModel)]="form.name" required />
      </div>
      <div class="row">
        <label>CNPJ*</label
        ><input
          name="cnpj"
          [(ngModel)]="form.cnpj"
          (input)="formatCnpj()"
          (keydown)="onCnpjKeyDown($event)"
          (paste)="onCnpjPaste($event)"
          maxlength="18"
          required
        />
      </div>
      <div class="row">
        <label>CEP*</label>
        <input
          name="addressZipCode"
          type="text"
          maxlength="9"
          [(ngModel)]="form.addressZipCode"
          (input)="formatCep()"
          (blur)="buscarCep()"
          (keyup.enter)="buscarCep()"
          required
        />
        <small *ngIf="buscandoCep">Buscando CEP...</small>
        <small class="erro" *ngIf="cepErro">{{ cepErro }}</small>
      </div>
      <div class="row">
        <label>Endereço*</label><input name="address" [(ngModel)]="form.address" required />
      </div>
      <div class="row">
        <label>Bairro*</label><input name="neighborhood" [(ngModel)]="form.neighborhood" required />
      </div>
      <div class="row">
        <label>Município*</label
        ><input name="municipality" [(ngModel)]="form.municipality" required />
      </div>
      <div class="row">
        <label>Estado*</label><input name="state" [(ngModel)]="form.state" required />
      </div>
      <div class="row">
        <label>País*</label><input name="country" [(ngModel)]="form.country" required />
      </div>
      <div class="row">
        <label>Telefone*</label
        ><input
          name="phone"
          type="text"
          maxlength="16"
          [(ngModel)]="form.phone"
          (input)="formatPhone()"
          required
        />
      </div>
      <div class="edit-actions">
        <button type="submit" class="btn-primario" [disabled]="loading || editEmpresaForm.invalid">
          {{ loading ? "Salvando..." : "Salvar" }}
        </button>
        <button
          type="button"
          class="btn-secundario"
          (click)="cancelarEdicao()"
          [disabled]="loading"
        >
          Cancelar
        </button>
      </div>
    </form>
  </ng-template>

  <!-- Form de criação para admin/employee sem empresa -->
  <form *ngIf="!isSupport && !hasCompany" (ngSubmit)="enviar()" #empresaForm="ngForm">
    <div class="row">
      <label>Nome*</label><input name="name" [(ngModel)]="form.name" required />
    </div>
    <div class="row">
      <label>CNPJ*</label
      ><input
        name="cnpj"
        [(ngModel)]="form.cnpj"
        (input)="formatCnpj()"
        (keydown)="onCnpjKeyDown($event)"
        (paste)="onCnpjPaste($event)"
        maxlength="18"
        required
      />
    </div>
    <div class="row">
      <label>CEP*</label>
      <input
        name="addressZipCode"
        type="text"
        maxlength="9"
        [(ngModel)]="form.addressZipCode"
        (input)="formatCep()"
        (blur)="buscarCep()"
        (keyup.enter)="buscarCep()"
        required
      />
      <small *ngIf="buscandoCep">Buscando CEP...</small>
      <small class="erro" *ngIf="cepErro">{{ cepErro }}</small>
    </div>
    <div class="row">
      <label>Endereço*</label><input name="address" [(ngModel)]="form.address" required />
    </div>
    <div class="row">
      <label>Bairro*</label><input name="neighborhood" [(ngModel)]="form.neighborhood" required />
    </div>
    <div class="row">
      <label>Município*</label
      ><input name="municipality" [(ngModel)]="form.municipality" required />
    </div>
    <div class="row">
      <label>Estado*</label><input name="state" [(ngModel)]="form.state" required />
    </div>
    <div class="row">
      <label>País*</label><input name="country" [(ngModel)]="form.country" required />
    </div>
    <div class="row">
      <label>Telefone*</label
      ><input
        name="phone"
        type="text"
        maxlength="16"
        [(ngModel)]="form.phone"
        (input)="formatPhone()"
        required
      />
    </div>
    <button type="submit" class="btn-primario" [disabled]="loading || empresaForm.invalid">
      {{ loading ? "Enviando..." : "Cadastrar" }}
    </button>
  </form>
  <!-- Mensagens inline removidas em favor dos banners fixos -->

  <!-- Listagem para suporte -->
  <div *ngIf="isSupport">
    <div class="support-actions">
      <button
        class="btn-primario"
        type="button"
        (click)="showCreateForSupport = !showCreateForSupport"
      >
        {{ showCreateForSupport ? "Voltar" : "Cadastrar Nova Empresa" }}
      </button>
    </div>
    <!-- Formulário (exclusivo quando criando) -->
    <form
      *ngIf="showCreateForSupport"
      (ngSubmit)="enviar()"
      #empresaFormSup="ngForm"
      class="empresa-form-suporte"
    >
      <div class="row">
        <label>Nome*</label><input name="name" [(ngModel)]="form.name" required />
      </div>
      <div class="row">
        <label>CNPJ*</label
        ><input
          name="cnpj"
          [(ngModel)]="form.cnpj"
          (input)="formatCnpj()"
          (keydown)="onCnpjKeyDown($event)"
          (paste)="onCnpjPaste($event)"
          maxlength="18"
          required
        />
      </div>
      <div class="row">
        <label>CEP*</label>
        <input
          name="addressZipCode"
          type="text"
          maxlength="9"
          [(ngModel)]="form.addressZipCode"
          (input)="formatCep()"
          (blur)="buscarCep()"
          (keyup.enter)="buscarCep()"
          required
        />
        <small *ngIf="buscandoCep">Buscando CEP...</small>
        <small class="erro" *ngIf="cepErro">{{ cepErro }}</small>
      </div>
      <div class="row">
        <label>Endereço*</label><input name="address" [(ngModel)]="form.address" required />
      </div>
      <div class="row">
        <label>Bairro*</label><input name="neighborhood" [(ngModel)]="form.neighborhood" required />
      </div>
      <div class="row">
        <label>Município*</label
        ><input name="municipality" [(ngModel)]="form.municipality" required />
      </div>
      <div class="row">
        <label>Estado*</label><input name="state" [(ngModel)]="form.state" required />
      </div>
      <div class="row">
        <label>País*</label><input name="country" [(ngModel)]="form.country" required />
      </div>
      <div class="row">
        <label>Telefone*</label
        ><input
          name="phone"
          type="text"
          maxlength="16"
          [(ngModel)]="form.phone"
          (input)="formatPhone()"
          required
        />
      </div>
      <button type="submit" class="btn-primario" [disabled]="loading || empresaFormSup.invalid">
        {{ loading ? "Enviando..." : "Salvar" }}
      </button>
    </form>
    <ng-container *ngIf="!showCreateForSupport">
      <div *ngIf="loadingCompanies">Carregando empresas...</div>
      <div *ngIf="!loadingCompanies && allCompanies.length === 0">Nenhuma empresa cadastrada.</div>
      <div class="lista-empresas" *ngIf="!loadingCompanies && allCompanies.length > 0">
        <div
          class="empresa-item"
          *ngFor="let c of allCompanies"
          (click)="navigateToCompanyUsers(c)"
          role="button"
          tabindex="0"
          (keydown.enter)="navigateToCompanyUsers(c)"
          (keydown.space)="navigateToCompanyUsers(c)"
        >
          <h4>{{ c.name }}</h4>
          <p class="cid"><strong>CNPJ:</strong> {{ viewCnpj(c.cnpj) }}</p>
          <p><strong>Local:</strong> {{ c.municipality }} / {{ c.state }}</p>
          <p><strong>Telefone:</strong> {{ viewPhone(c.phone) }}</p>
        </div>
      </div>
    </ng-container>
  </div>
</div>
<div *ngIf="!companyLoaded">Carregando...</div>
