<div class="cadastro-pesquisa">
  <app-loading-indicator *ngIf="loadingOverlay"></app-loading-indicator>
  <div *ngIf="bannerMsg" class="top-banner" [ngClass]="bannerTipo">
    <span>{{ bannerMsg }}</span>
    <button type="button" class="close-btn" (click)="fecharBanner()">×</button>
  </div>
  <form (ngSubmit)="cadastrar()" autocomplete="off">
    <div class="titulo-row">
      <h3>{{ emEdicao ? "Editar Pesquisa" : "Nova Pesquisa" }}</h3>
      <span class="badge" [class.pulso]="tipo === 'pulso'" [class.clima]="tipo === 'clima'">{{
        tipo
      }}</span>
    </div>
    <label for="tipo">Tipo</label>
    <div class="tipo-switch">
      <button
        type="button"
        [class.ativo]="tipo === 'pulso'"
        (click)="tipo = 'pulso'; onChangeTipo()"
      >
        Pulso
      </button>
      <button
        type="button"
        [class.ativo]="tipo === 'clima'"
        (click)="tipo = 'clima'; onChangeTipo()"
      >
        Clima
      </button>
    </div>
    <div class="field">
      <label for="titulo">Título</label>
      <input
        id="titulo"
        [(ngModel)]="titulo"
        name="titulo"
        maxlength="80"
        placeholder="Ex: Termômetro semanal"
        required
      />
      <small class="hint">Máx. 80 caracteres</small>
    </div>
    <div class="field"></div>
    <!-- Alcance da pesquisa -->
    <div class="field">
      <label>Alcance</label>
      <div class="inline">
        <label class="switch"
          ><input type="radio" [(ngModel)]="alcance" name="alcance" value="todos" />
          <span>Todos os departamentos</span></label
        >
        <label class="switch"
          ><input type="radio" [(ngModel)]="alcance" name="alcance" value="setores" />
          <span>Selecionar departamentos</span></label
        >
      </div>
      <div class="multi-list" *ngIf="alcance === 'setores'">
        <div class="check-row" *ngFor="let d of departamentos">
          <label>
            <input
              type="checkbox"
              [checked]="selectedDepartmentIds.includes(d.id)"
              (change)="toggleDepartment(d.id, $any($event.target).checked)"
            />
            <span>{{
              d.name || d.nome || d.title || d.label || d.departmentName || d.description || d
            }}</span>
          </label>
        </div>
        <small class="hint"
          >Marque um ou mais departamentos. Somente colaboradores desses departamentos verão a
          pesquisa.</small
        >
      </div>
    </div>
    <div *ngIf="sucesso" class="sucesso">Salvo!</div>
    <div *ngIf="erro" class="erro">{{ erro }}</div>
    <div class="questions-box" *ngIf="!carregandoPerguntas">
      <div class="qb-header">
        <h4>Perguntas Padrão</h4>
        <div class="inline-actions">
          <button
            type="button"
            class="restore"
            (click)="restaurarPadrao()"
            [disabled]="perguntasSelecionadas.length === perguntasPadrao.length"
          >
            Restaurar
          </button>
          <button type="button" class="restore import" (click)="openImportModal()">
            Importar perguntas
          </button>
        </div>
      </div>
      <ul class="qs-list" *ngIf="perguntasSelecionadas.length; else noneTpl">
        <li
          *ngFor="let p of perguntasSelecionadas; let i = index"
          [draggable]="canDrag(i)"
          (dragstart)="onDragStart(i, $event)"
          (dragover)="onDragOver(i, $event)"
          (drop)="onDrop(i, $event)"
          (dragend)="onDragEnd($event)"
          [class.is-dragging]="dragIndex === i"
          [class.drag-over]="dragOverIndex === i"
          [class.drag-over-before]="dragOverIndex === i && dragOverBefore === true"
          [class.drag-over-after]="dragOverIndex === i && dragOverBefore === false"
        >
          <span class="idx">{{ i + 1 }}.</span>
          <span class="txt">{{ p.texto }}</span>
          <div class="meta">
            <span class="drag-handle" title="Arraste para reordenar">≡</span>
            <label class="obg-toggle">
              <input
                type="checkbox"
                [(ngModel)]="p.obrigatoria"
                [ngModelOptions]="{ standalone: true }"
              />
              <span class="flag" [class.on]="p.obrigatoria">Obrigatória</span>
            </label>
            <span
              class="tag"
              [class.qualitativa]="p.tipoResposta === 'qualitativa'"
              [class.quantitativa]="p.tipoResposta === 'quantitativa'"
              >{{ p.tipoResposta || "quantitativa" }}</span
            >
            <span *ngIf="tipo === 'pulso' && i === 0" class="tag">NPS</span>
            <button
              *ngIf="!(tipo === 'pulso' && i === 0)"
              type="button"
              class="rem"
              (click)="removerPergunta(i)"
            >
              Remover
            </button>
          </div>
        </li>
      </ul>
      <ng-template #noneTpl>
        <div class="placeholder">Todas removidas. Clique em Restaurar para trazer novamente.</div>
      </ng-template>
      <div class="add-custom">
        <label
          >Nova pergunta personalizada (vem marcada como obrigatória por padrão — você pode
          desmarcar depois na lista)</label
        >
        <input
          type="text"
          [(ngModel)]="novaPerguntaTexto"
          name="novaPerguntaTexto"
          placeholder="Digite o enunciado"
          maxlength="200"
        />
        <div class="inline">
          <div class="switch">
            <label
              ><input
                type="radio"
                [(ngModel)]="novaPerguntaTipoResposta"
                name="novaPerguntaTipoResposta"
                value="quantitativa"
              />
              Quantitativa</label
            >
            <label
              ><input
                type="radio"
                [(ngModel)]="novaPerguntaTipoResposta"
                name="novaPerguntaTipoResposta"
                value="qualitativa"
              />
              Qualitativa</label
            >
          </div>
          <div class="switch">
            <label
              ><input type="checkbox" [(ngModel)]="salvarNoBanco" name="salvarNoBanco" /> Salvar no
              banco de perguntas</label
            >
          </div>
          <button
            type="button"
            (click)="addPerguntaCustom()"
            [disabled]="!novaPerguntaTexto.trim()"
          >
            Adicionar
          </button>
        </div>
        <small class="hint" *ngIf="tipo === 'pulso' && novaPerguntaTipoResposta === 'quantitativa'"
          >Escala 0–10 aplicada automaticamente.</small
        >
        <small class="hint" *ngIf="tipo === 'clima' && novaPerguntaTipoResposta === 'quantitativa'"
          >Escala 1–5 (Likert) aplicada automaticamente.</small
        >
        <small class="hint" *ngIf="novaPerguntaTipoResposta === 'qualitativa'"
          >Resposta aberta (texto) – sem escala numérica.</small
        >
      </div>

      <div class="actions">
        <button type="submit" [disabled]="!titulo.trim() || carregando">
          <span *ngIf="!carregando">{{ emEdicao ? "Salvar" : "Cadastrar" }}</span>
          <span *ngIf="carregando" class="loader"></span>
        </button>
      </div>
    </div>
    <div *ngIf="carregandoPerguntas" class="loading-mini">Carregando perguntas...</div>
  </form>

  <!-- Modal Importar Perguntas -->
  <div class="modal-overlay" *ngIf="showImportModal" (click)="closeImportModal()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="md-header">
        <h5>Importar Perguntas ({{ tipo }})</h5>
      </div>
      <div class="filters">
        <label class="switch"
          ><input
            type="radio"
            [(ngModel)]="filtroTipoBanco"
            name="fltTipo"
            value="todas"
            (change)="carregarBanco()"
          /><span>Todas</span></label
        >
        <label class="switch"
          ><input
            type="radio"
            [(ngModel)]="filtroTipoBanco"
            name="fltTipo"
            value="quantitativa"
            (change)="carregarBanco()"
          /><span>Quantitativas</span></label
        >
        <label class="switch"
          ><input
            type="radio"
            [(ngModel)]="filtroTipoBanco"
            name="fltTipo"
            value="qualitativa"
            (change)="carregarBanco()"
          /><span>Qualitativas</span></label
        >
      </div>
      <div class="mini-list" *ngIf="!carregandoBanco">
        <div class="row" *ngFor="let q of bancoPerguntas">
          <div class="t">
            <div class="txt">{{ q.texto }}</div>
            <div class="sub">
              {{ q.modalidade }} •
              <span
                class="tag"
                [class.quantitativa]="q.tipoResposta === 'quantitativa'"
                [class.qualitativa]="q.tipoResposta === 'qualitativa'"
                >{{ q.tipoResposta }}</span
              >
            </div>
          </div>
          <button
            type="button"
            class="imp"
            (click)="importarDaBase(q)"
            [disabled]="bannerMsg && bannerTipo === 'erro'"
          >
            Importar
          </button>
        </div>
        <div *ngIf="!bancoPerguntas.length" class="placeholder">
          Nenhuma pergunta ativa cadastrada para este tipo.
        </div>
      </div>
      <div *ngIf="carregandoBanco" class="loading-mini">Carregando...</div>
      <div class="modal-actions">
        <button type="button" class="btn-ghost" (click)="closeImportModal()">Fechar</button>
      </div>
    </div>
  </div>
</div>
