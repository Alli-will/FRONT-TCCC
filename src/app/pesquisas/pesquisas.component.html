<app-menu>
  <div class="pesquisas-page">
    <div class="header-row">
      <h2 *ngIf="!isAdmin" class="gradient-text">Pesquisas Disponíveis</h2>
      <div class="tabs" *ngIf="isAdmin">
        <button *ngIf="modo === 'listar'" class="ativo" (click)="modo = 'cadastrar'">
          Nova Pesquisa
        </button>
        <button *ngIf="modo === 'cadastrar'" class="ativo" (click)="modo = 'listar'">
          Voltar para Pesquisas
        </button>
      </div>
    </div>

    <div class="content-grid" *ngIf="modo === 'listar'">
      <div *ngIf="bannerMsg" class="top-banner" [ngClass]="bannerTipo">
        <span>{{ bannerMsg }}</span>
        <button type="button" class="close-btn" (click)="fecharBanner()">×</button>
      </div>
      <div class="card full">
        <h3 class="card-title"><span class="gradient-text">Pesquisas Disponíveis</span></h3>
        <div *ngIf="erro" class="alert erro">{{ erro }}</div>
        <ul class="lista" *ngIf="pesquisas.length">
          <li *ngFor="let pesquisa of pesquisas">
            <div class="item">
              <div class="info">
                <span class="titulo">{{ pesquisa.titulo }}</span>
                <span
                  class="tag"
                  [class.pulso]="pesquisa.tipo === 'pulso'"
                  [class.clima]="pesquisa.tipo === 'clima'"
                  >{{ pesquisa.tipo }}</span
                >
              </div>
              <div class="meta" style="display: flex; gap: 0.5rem; align-items: center">
                <a class="responder-link" [routerLink]="['/responder-pesquisa', pesquisa.id]"
                  >Responder</a
                >
                <ng-container *ngIf="isAdmin">
                  <button
                    class="btn-ghost"
                    (click)="iniciarEdicao(pesquisa)"
                    [title]="
                      (pesquisa.respondentes ?? 0) > 0
                        ? 'Já possui respostas e não pode ser editada'
                        : ''
                    "
                  >
                    Editar
                  </button>
                  <button
                    class="btn-ghost danger"
                    (click)="excluir(pesquisa)"
                    [title]="
                      (pesquisa.respondentes ?? 0) > 0
                        ? 'Já possui respostas e não pode ser excluída'
                        : ''
                    "
                  >
                    Excluir
                  </button>
                </ng-container>
              </div>
            </div>
          </li>
        </ul>
        <div class="empty" *ngIf="!pesquisas.length && !erro">
          <svg class="empty-icon" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
            <path
              d="M8 12h8M8 16h5M8 8h8"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
          <span>Nenhuma pesquisa Disponível no momento.</span>
        </div>

        <div class="paginacao" *ngIf="totalPages > 1">
          <button (click)="mudarPagina(-1)" [disabled]="page === 1">«</button>
          <span>Página {{ page }} de {{ totalPages }}</span>
          <button (click)="mudarPagina(1)" [disabled]="page === totalPages">»</button>
        </div>
      </div>
    </div>

    <div class="content-grid" *ngIf="modo === 'cadastrar' && isAdmin">
      <div class="card form-card">
        <app-cadastro-pesquisa
          (criado)="onCriado($event)"
          [editarDe]="editando"
        ></app-cadastro-pesquisa>
      </div>
    </div>
  </div>
</app-menu>

<!-- Modal informativo simples -->
<div class="modal-overlay" *ngIf="showInfoModal" (click)="closeInfoModal()">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <div class="md-header">
      <h5>{{ infoTitle }}</h5>
    </div>
    <div class="md-body">
      <p>{{ infoMessage }}</p>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" type="button" (click)="closeInfoModal()">Ok</button>
    </div>
  </div>
</div>

<!-- Modal de confirmação de exclusão -->
<div class="modal-overlay" *ngIf="showConfirmModal" (click)="cancelarExcluir()">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <div class="md-header">
      <h5>{{ confirmTitle }}</h5>
    </div>
    <div class="md-body">
      <p>{{ confirmMessage }}</p>
    </div>
    <div class="modal-actions" style="display: flex; gap: 0.5rem; justify-content: flex-end">
      <button class="btn-ghost" type="button" (click)="cancelarExcluir()" [disabled]="deletando">
        Cancelar
      </button>
      <button
        class="btn-ghost danger"
        type="button"
        (click)="confirmExcluir()"
        [disabled]="deletando"
      >
        <span *ngIf="deletando" class="loader-mini" aria-hidden="true"></span>
        <span>{{ deletando ? "Excluindo…" : "Excluir" }}</span>
      </button>
    </div>
  </div>
</div>
