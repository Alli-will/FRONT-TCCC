<app-menu>
  <div
    *ngIf="mensagem"
    class="top-banner"
    [class.erro]="bannerTipo === 'erro'"
    [class.sucesso]="bannerTipo === 'sucesso'"
    role="alert"
    aria-live="assertive"
  >
    <div class="msg">{{ mensagem }}</div>
    <button type="button" (click)="dismissBanner()" aria-label="Fechar">Fechar</button>
  </div>
  <div class="page">
    <div class="card">
      <div class="header-row">
        <h2>Perguntas</h2>
        <a class="btn-primario" routerLink="/perguntas/nova">Nova pergunta</a>
      </div>

      <div class="filter-card">
        <div class="search-wrapper">
          <input
            class="search-input-lg"
            type="text"
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()"
            placeholder="Buscar descrição..."
            title="Pesquisar pela descrição da pergunta"
          />
          <span class="search-icon" aria-hidden="true">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </span>
        </div>
        <div class="status-filter">
          <label for="statusSelect">Status</label>
          <select
            id="statusSelect"
            class="status-select"
            [(ngModel)]="statusFilter"
            (ngModelChange)="onStatusChange()"
          >
            <option value="todas">Todas</option>
            <option value="ativas">Ativas</option>
            <option value="inativas">Inativas</option>
          </select>
        </div>
      </div>
      <div *ngIf="loading" class="status">Carregando...</div>
      <div *ngIf="!loading && (!items || !items.length)" class="status">
        Nenhuma pergunta cadastrada.
      </div>
      <div class="table" *ngIf="!loading && items.length">
        <div class="thead">
          <div class="cell col-pergunta">Pergunta</div>
          <div class="cell col-modalidade">Modalidade</div>
          <div class="cell col-tipo">Tipo</div>
          <div class="cell col-status">Status</div>
          <div class="cell col-data">Cadastrada em</div>
          <div class="cell col-opcoes">Opções</div>
        </div>
        <div class="row" *ngFor="let q of displayed">
          <div class="cell col-pergunta">
            <div class="texto">{{ q.texto }}</div>
            <div class="meta">{{ q.descricaoBusca || "—" }}</div>
          </div>
          <div class="cell col-modalidade">{{ q.modalidade | titlecase }}</div>
          <div class="cell col-tipo">{{ q.tipoResposta | titlecase }}</div>
          <div class="cell col-status">
            <span class="badge" [class.inativo]="q.ativo === false">{{
              q.ativo === false ? "Inativa" : "Ativa"
            }}</span>
          </div>
          <div class="cell col-data">{{ q.createdAt | date: "dd/MM/yyyy" }}</div>
          <div class="cell col-opcoes">
            <div class="options">
              <button class="options-btn" (click)="toggleMenu(q.id)" aria-label="Opções">⋯</button>
              <div class="menu" *ngIf="openMenuId === q.id">
                <a class="link" [routerLink]="['/perguntas', q.id, 'editar']">Editar</a>
                <button (click)="toggleAtivo(q)">
                  {{ q.ativo === false ? "Ativar" : "Inativar" }}
                </button>
                <button class="danger" (click)="openConfirm(q)">Excluir</button>
              </div>
            </div>
          </div>
        </div>
        <div class="paginacao-container" *ngIf="total > pageSize">
          <button (click)="changePage(-1)" [disabled]="page === 1">Anterior</button>
          <ng-container *ngFor="let _ of [].constructor(totalPages); let i = index">
            <button (click)="goToPage(i + 1)" [class.ativa]="page === i + 1">{{ i + 1 }}</button>
          </ng-container>
          <button (click)="changePage(1)" [disabled]="page === totalPages">Próxima</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmação de exclusão -->
  <div class="modal-overlay" *ngIf="confirmOpen" (click)="closeConfirm()">
    <div
      class="modal-card"
      role="dialog"
      aria-modal="true"
      aria-labelledby="confirm-title"
      (click)="$event.stopPropagation()"
    >
      <h3 id="confirm-title">Excluir pergunta</h3>
      <p>Tem certeza que deseja excluir esta pergunta? Essa ação não pode ser desfeita.</p>
      <div class="modal-actions">
        <button type="button" class="btn-ghost" (click)="closeConfirm()" [disabled]="deleting">
          Cancelar
        </button>
        <button
          type="button"
          class="btn-primario danger"
          (click)="confirmarExclusao()"
          [disabled]="deleting"
        >
          {{ deleting ? "Excluindo..." : "Excluir" }}
        </button>
      </div>
    </div>
  </div>
</app-menu>
